{% extends "base.html" %}
{% block title %}WELCOME{% endblock %}

{% block content %}
<div class="service-section px-5 py-8 md:p-8 bg-white dark:bg-nightBlack rounded-2xl lg:p-10 2xl:p-13">
    <div
        class="inline-flex items-center gap-2 px-4 py-2 text-xs tracking-wide text-black dark:text-white border lg:px-5 section-name border-platinum dark:border-greyBlack200 rounded-4xl">
        <i class="fal fa-briefcase text-theme"></i>
        AI-Tools
    </div>
    <div class="mb-8 mt-7 md:my-10 section-title">
        <h2 class="title text-[32px] md:text-4xl lg:text-5xl font-extralight text-black dark:text-white leading-1.27">
            <span class="font-semibold text-theme">Symptom Analyser</span>
        </h2>
        <p class="max-w-xxl mt-4 md:mt-6 subtitle">
            Medication errors in medical diagnosis can pose serious risks to patients. Mistakes may occur when a
            condition is incorrectly diagnosed, leading to medications being prescribed, prepared, or dispensed
            improperly. According to the U.S. Food and Drug Administration (FDA), approximately 100,000 medication
            errors were reported in 2019, with nearly 55% resulting from incorrect dispensing.

            To address this, the Symptom Analyser leverages AI to assist patients in identifying potential health
            conditions based on their symptoms. Users can input their symptoms and receive possible diagnoses, detailed
            information about each condition, and guidance on appropriate next steps. The tool is designed for ease of
            use and broad accessibility, empowering individuals to make more informed healthcare decisions.
        </p>
    </div>

    <div class="mt-6">
        <h2 class="text-xl font-medium text-black dark:text-white mb-3">Select symptoms</h2>
        <form method="post" class="max-w-lg">
            <div class="mb-4 max-h-96 overflow-y-auto p-4 border border-platinum dark:border-greyBlack200 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="itching" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Itching</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="skin_rash" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Skin Rash</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="continuous_sneezing" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Continuous Sneezing</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="shivering" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Shivering</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="chills" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Chills</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="joint_pain" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Joint Pain</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="stomach_pain" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Stomach Pain</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="ulcers_on_tongue" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Ulcers on tongue</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="vomiting" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Vomiting</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="fatigue" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Fatigue</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="anxiety" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Anxiety</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="cold_hands_and_feets" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Cold hands and feet</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="cough" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Cough</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="high_fever" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">High Fever</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="breathlessness" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Breathlessness</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="headache" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Headache</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="nausea" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Nausea</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="loss_of_appetite" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Loss of Appetite</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="abdominal_pain" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Abdominal Pain</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="diarrhoea" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Diarrhoea</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="throat_irritation" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Throat Irritation</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="symptoms[]" value="chest_pain" class="form-checkbox text-theme rounded">
                        <span class="text-black dark:text-white">Chest Pain</span>
                    </label>
                </div>
            </div>
            
            <div id="selected-symptoms-summary" class="flex flex-wrap gap-2 mb-4 text-sm text-black dark:text-white">
                <span id="selected-count">0</span> symptoms selected
                <div id="selected-symptoms-tags" class="flex flex-wrap gap-2 mt-2 w-full"></div>
            </div>
            
            <button type="submit" id="analyse-btn" class="px-6 py-2 bg-theme text-white hover:bg-opacity-90 transition-all">
                Analyse Symptoms
            </button>
            
            <div id="loading-indicator" class="hidden mt-4 items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-theme mr-3"></div>
                <span class="text-black dark:text-white">Analysing symptoms...</span>
            </div>
        </form>
    </div>

    <!-- Analysis Results Section -->
    <div id="results-container" class="mt-8 border-t pt-6 border-platinum dark:border-greyBlack200 hidden">
        <div class="bg-gray-50 dark:bg-greyBlack200 rounded-xl p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full bg-theme flex items-center justify-center mr-3">
                    <i class="fas fa-stethoscope text-white"></i>
                </div>
                <h3 class="text-2xl font-medium text-black dark:text-white"> Analysis Results</h3>
            </div>
            
            <div class="mb-4">
                <h4 class="text-xl font-medium text-theme mb-2">Predicted Disease</h4>
                <p id="result-disease" class="text-black dark:text-white text-lg font-semibold"></p>
            </div>
            
            <div class="mb-4">
                <h4 class="text-lg font-medium text-black dark:text-white mb-2">Description</h4>
                <p id="result-description" class="text-gray-700 dark:text-gray-300"></p>
            </div>
            
            <div class="mb-2">
                <h4 class="text-lg font-medium text-black dark:text-white mb-2">Recommended Actions</h4>
                <ul id="result-recommendations" class="list-disc pl-5 text-gray-700 dark:text-gray-300">
                </ul>
            </div>
            
            <div class="mt-6 text-sm text-gray-500 dark:text-gray-400">
                <p class="italic">Note: This analysis is based on the symptoms you provided and is not a substitute for professional medical advice. Please consult with a healthcare provider for proper diagnosis and treatment.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name="symptoms[]"]');
        const selectedCountElement = document.getElementById('selected-count');
        const selectedSymptomsTagsElement = document.getElementById('selected-symptoms-tags');
        const form = document.querySelector('form');
        const analyseBtn = document.getElementById('analyse-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        
        // Update selected symptoms count and tags
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedSymptoms);
        });
        
        function updateSelectedSymptoms() {
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"][name="symptoms[]"]:checked');
            const selectedCount = selectedCheckboxes.length;
            selectedCountElement.textContent = selectedCount;
            
            // Clear previous tags
            selectedSymptomsTagsElement.innerHTML = '';
            
            // Add tags for each selected symptom
            selectedCheckboxes.forEach(checkbox => {
                const tag = document.createElement('div');
                tag.className = 'px-3 py-1 bg-white dark:bg-greyBlack200 text-black dark:text-white border border-platinum dark:border-greyBlack200 text-xs mr-2 mb-2';
                
                // Convert symptom_name to readable format (e.g., 'skin_rash' -> 'Skin Rash')
                const symptomName = checkbox.value.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                
                tag.textContent = symptomName;
                selectedSymptomsTagsElement.appendChild(tag);
            });
        }
        
        // Form submission with AJAX
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const selectedSymptoms = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSymptoms.push(checkbox.value);
                }
            });
            
            if (selectedSymptoms.length === 0) {
                alert('Please select at least one symptom');
                return;
            }
            
            console.log('Sending symptoms:', selectedSymptoms);
            
            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.style.display = 'flex'; // Ensure it's displayed as flex
            analyseBtn.disabled = true;
            
            // Send AJAX request to symptom-analyser instead of symptom-analysis
            fetch('/symptom-analyser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    symptoms: selectedSymptoms
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                // Check if the response is ok (status in the range 200-299)
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server responded with status ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                loadingIndicator.style.display = 'none'; // Ensure it's completely hidden
                analyseBtn.disabled = false;
                
                // Make sure data contains the expected fields
                if (!data.disease || !data.description || !data.recommendations) {
                    throw new Error('Received incomplete data from server');
                }
                
                // Display results
                displayResults(data);
            })
            .catch(error => {
                console.error('Error details:', error);
                loadingIndicator.classList.add('hidden');
                loadingIndicator.style.display = 'none'; // Ensure it's completely hidden
                analyseBtn.disabled = false;
                
                // More descriptive error message
                if (error.message && error.message.includes('Failed to fetch')) {
                    alert('Network error: Could not connect to the server. Please check your internet connection and try again.');
                } else {
                    alert(`Error: ${error.message || 'An unknown error occurred while analyzing symptoms. Please try again.'}`);
                }
            });
        });
        
        function displayResults(data) {
            // Show results container
            resultsContainer.classList.remove('hidden');
            
            // Update result elements with safer access to data properties
            document.getElementById('result-disease').textContent = data.disease || 'Unknown condition';
            document.getElementById('result-description').textContent = data.description || 'No description available';
            
            // Clear previous recommendations
            const recommendationsList = document.getElementById('result-recommendations');
            recommendationsList.innerHTML = '';
            
            // Add new recommendations with safety check
            if (Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                data.recommendations.forEach(recommendation => {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    li.textContent = recommendation;
                    recommendationsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'mb-1';
                li.textContent = 'No specific recommendations available';
                recommendationsList.appendChild(li);
            }
            
            // Add selected symptoms to the description
            if (data.selected_symptoms) {
                const selectedSymptoms = data.selected_symptoms.join(', ');
                document.getElementById('result-description').textContent += 
                    `\n\n`;
            }
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
    });
</script>
{% endblock %}